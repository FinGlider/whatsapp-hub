# Managing Meta Access Tokens and Verify Tokens

## Overview

Each Meta/WhatsApp app has its own set of tokens:

- **Verify Token**: A secret you create for webhook verification
- **Access Token**: Generated by Meta for API calls
- **WABA ID**: WhatsApp Business Account ID

These tokens are now stored **per app in the database**, not in `.env` files.

## Why Store Tokens in Database?

✅ **Different tokens per app**: Each Meta app has unique tokens  
✅ **Multiple apps support**: Manage many apps easily  
✅ **No code changes**: Add new apps without redeploying  
✅ **Better security**: Tokens can be encrypted/rotated via API

## How to Add an App with Tokens

### Step 1: Get Your Tokens from Meta

1. Go to [Meta Developer Portal](https://developers.facebook.com)
2. Select your app
3. Go to **WhatsApp** > **API Setup**
4. Copy:
   - **Temporary Access Token** (or generate a permanent one)
   - **Phone Number ID**
   - **WhatsApp Business Account ID** (WABA ID)
5. Create your own **Verify Token** (any secure random string)

### Step 2: Create Business Account (One-Time)

**Important**: Use your **WABA ID from Meta** as the `business_id`:

```bash
curl -X POST http://localhost:3138/admin/business-accounts \
  -H "Content-Type: application/json" \
  -d '{
    "business_id": "123456789",
    "name": "Your Company Name",
    "timezone": "America/New_York"
  }'
```

> **Note**: The `business_id` here IS your WhatsApp Business Account ID (WABA ID) from Meta.

### Step 3: Create App with Tokens

```bash
curl -X POST http://localhost:3138/admin/apps \
  -H "Content-Type: application/json" \
  -d '{
    "id": "my-app-1",
    "business_id": "123456789",
    "name": "Promotion App",
    "verify_token": "my_secure_verify_token_123",
    "access_token": "EAAN8Ny1skzkBO6Wl..."
  }'
```

> **Note**: Use the same `business_id` (WABA ID) from Step 2.

### Step 4: Add Phone Number

```bash
curl -X POST http://localhost:3138/admin/phone-numbers \
  -H "Content-Type: application/json" \
  -d '{
    "phone_number_id": "542491768952983",
    "app_id": "my-app-1",
    "phone_number": "+1234567890",
    "display_name": "Main Business Line"
  }'
```

### Step 5: Add Project and Map It

```bash
# Create project
curl -X POST http://localhost:3138/admin/projects \
  -H "Content-Type: application/json" \
  -d '{
    "name": "My Backend Service",
    "endpoint": "https://myapi.example.com/webhook",
    "description": "Handles customer messages"
  }'

# Map phone to project (use project ID from above response)
curl -X POST http://localhost:3138/admin/mappings \
  -H "Content-Type: application/json" \
  -d '{
    "phone_number_id": "542491768952983",
    "project_id": 1,
    "priority": 100
  }'
```

## Multiple Apps Example

### App 1: Promotion Service

```bash
curl -X POST http://localhost:3138/admin/apps \
  -H "Content-Type: application/json" \
  -d '{
    "id": "promotion-app",
    "business_id": "123456789",
    "name": "Promotion App",
    "verify_token": "promo_token_xyz",
    "access_token": "EAAN8Ny1skzkBO6Wl_PROMO..."
  }'
```

### App 2: Customer Support

```bash
curl -X POST http://localhost:3138/admin/apps \
  -H "Content-Type: application/json" \
  -d '{
    "id": "support-app",
    "business_id": "123456789",
    "name": "Customer Support App",
    "verify_token": "support_token_abc",
    "access_token": "EAAN8Ny1skzkBO6Wl_SUPPORT..."
  }'
```

## View Apps and Their Tokens

```bash
# List all apps for a business account
curl http://localhost:3138/admin/business-accounts/123456789/apps

# Response:
[
  {
    "id": "promotion-app",
    "name": "Promotion App",
    "verify_token": "promo_token_xyz",
    "access_token": "EAAN8Ny1skzkBO6Wl_PROMO...",
    "business_id": "123456789"
  },
  {
    "id": "support-app",
    "name": "Customer Support App",
    "verify_token": "support_token_abc",
    "access_token": "EAAN8Ny1skzkBO6Wl_SUPPORT...",
    "business_id": "123456789"
  }
]
```

## Configure Meta Webhook

When setting up webhook in Meta Developer Portal:

1. **Callback URL**: `https://your-domain.com/meta/webhook`
2. **Verify Token**: Use the `verify_token` you stored for that specific app
3. The hub will automatically find the correct app by matching the verify token

## How Tokens Are Used

### During Webhook Verification (Meta → Your Hub)

```
1. Meta sends: GET /meta/webhook?hub.verify_token=promo_token_xyz
2. Hub queries database: SELECT * FROM apps WHERE verify_token = 'promo_token_xyz'
3. Hub finds "promotion-app"
4. Hub returns challenge (verified!)
```

### During Message Delivery (Meta → Your Hub → Your Project)

```
1. Meta sends: POST /meta/webhook with phone_number_id
2. Hub queries: Which projects are mapped to this phone number?
3. Hub gets: app info (including access_token)
4. Hub forwards webhook to your project endpoints
5. Your project can use the access_token to reply via WhatsApp API
```

## Security Best Practices

1. **Rotate tokens regularly**: Update tokens via Admin API
2. **Use HTTPS**: Always use SSL in production
3. **Secure database**: Encrypt sensitive fields if needed
4. **Limit API access**: Add authentication to Admin API
5. **Monitor token usage**: Track API calls per app

## Updating Tokens

```bash
# Update app tokens (requires implementing PUT /admin/apps/:id)
curl -X PUT http://localhost:3138/admin/apps/promotion-app \
  -H "Content-Type: application/json" \
  -d '{
    "access_token": "NEW_TOKEN_HERE",
    "verify_token": "new_verify_token"
  }'
```

## Migration from Old Setup

If you had tokens in `.env` before:

```bash
# Old .env
META_VERIFY_TOKEN=hafis
Meta_access_token=EAAN8Ny1skzkBO...

# Now: Add to database
curl -X POST http://localhost:3138/admin/apps \
  -H "Content-Type: application/json" \
  -d '{
    "id": "legacy-app",
    "business_id": "YOUR_WABA_ID",
    "name": "Legacy App",
    "verify_token": "hafis",
    "access_token": "EAAN8Ny1skzkBO..."
  }'
```

## Summary

✅ Each Meta app has its own tokens  
✅ Tokens are stored in the `apps` table  
✅ Use Admin API to manage tokens  
✅ No need to modify code when adding new apps  
✅ Each phone number can route to multiple projects  
✅ Each project receives webhooks with associated app tokens
